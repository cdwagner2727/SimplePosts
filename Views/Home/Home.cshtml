@model SimplePosts.ViewModel.PostVM

@{
    Layout = null;
}

<!DOCTYPE html>

<html>
    <head>
        <meta name="viewport" content="width=device-width" />
        <title>Posts for @Session["Username"]</title>

        <script src="@Url.Content("~/Scripts/jquery-2.2.3.js")"></script>
        <script src="@Url.Content("~/Scripts/jquery.validate.js")"></script>
        <script src="@Url.Content("~/Scripts/jquery.validate.unobtrusive.js")"></script>
        <script src="@Url.Content("~/Scripts/knockout-3.4.0.js")"></script>
        <script src="@Url.Content("~/Scripts/knockout.mapping-latest.js")"></script>

        <style>
            tbody {margin-bottom: 2em;}
        </style>
    </head>
    <body>
        <div>
            @if (@Model.UserObj.Username == "Guest")
            {
                <p>Welcome, Guest.  Please feel free to <a href="/Login/Login/">Login</a> or <a href="/Login/Register">Register</a></p>
                
            }
            else
            {
                <p>Welcome, @Model.UserObj.Username.  Not @Model.UserObj.Username? <a href="/Login/Logout/">Logout</a></p>
                using (Html.BeginForm("AddPost", "Home", FormMethod.Post, new { onsubmit = "return addPost(event);" }))
                {
                    <i>Title:   </i>@Html.TextBoxFor(p => p.PostObj.Title, new { @id = "titleInput" })<br /><span>@Html.ValidationMessageFor(p => p.PostObj.Title)</span><br />
                    <i>Content:   </i>@Html.TextAreaFor(p => p.PostObj.Content, new { @id = "contentInput" })<br /><span>@Html.ValidationMessageFor(p => p.PostObj.Content)</span><br />
                    <i>Make post public?</i>@Html.CheckBoxFor(p => p.PostObj.Public, new { @id = "publicInput" })
                    <input id="submit" type="submit" value="Save" />
                }
            }
            
            
        </div>
        
        <div>
            @if (@Model.UserObj.Username == "Guest"){
                <div><h4>Public posts:</h4></div>
            }
                <div data-bind ="foreach: posts">
                    <table style="margin-bottom: 2em">
                        <tr>
                            <td>Title:</td>
                            <td>
                                <span data-bind="text: Title, visible: !editable()"></span>
                                <span data-bind="visible: editable"><input type="text" data-bind="value: Title, attr: { 'id': $index() + 'titleEdit' }" /><a href="#" data-bind="click: toggleEditable">[X]</a></span>
                            </td>
                        </tr>
                        <tr>
                            <td>Author:</td>
                            <td>
                                @Model.UserObj.Username
                            </td>
                        </tr>
                        <tr>
                            <td>Content:</td>
                            <td>
                                <span data-bind="text: Content, visible: !editable()"></span>
                                <span data-bind="visible: editable"><input type="text" data-bind="value: Content, attr: { 'id': $index() + 'contentEdit' }" /></span>
                            </td>
                        </tr>
                        @if (@Model.UserObj.Username != "Guest"){
                            <tr>
                                <td>
                                    <span data-bind="visible: !editable()">
                                        <input type="button" data-bind="click: toggleEditable, visible: !editable()" value="Edit" />
                                    </span>
                                    <span data-bind="visible: editable">
                                        <input type="button" data-bind="click: updatePost" value="Save" />
                                        <span>Is public: <input type="checkbox" data-bind="checked: Public, attr: { 'id': $index() + 'publicEdit' }" /></span>
                                    </span>
                                </td>
                                <td><input type="button" data-bind="click: removePost" value="Remove" /></td>
                            </tr>
                        }
                </table>
            </div>
        </div>
        <script type="text/javascript">

            var postVM = function() {
                var self = this;
                self.posts = ko.observableArray([]);

                var mapping = 
                {
                    create: function(_data) {
                        return new Data(_data.data);
                    }
                };

                var Data = function (data) {
                    var self = this;

                    ko.mapping.fromJS(data, {}, self);

                    self.editable = ko.observable(false);
                };
    
                self.addData = function (_data) {
                    ko.mapping.fromJS(_data, mapping, self.posts);
                };

                var rawData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model));
                self.addData(rawData.PostList);

                self.toggleEditable = function (post) {
                    post.editable(!post.editable());
                };

                self.removePost = function () {
                    var localThis = this;
                    self.postChanges("/Home/RemovePost/", this, function(){
                        self.posts.remove(localThis);
                    });
                };

                self.updatePost = function (data, event) {
                    var context = ko.contextFor(event.target);
                    var index = context.$index();
                    var titleSel = "#" + index + "titleEdit";
                    var contentSel = "#" + index + "contentEdit";
                    var publicSel = "#" + index + "publicEdit";
                    this.Title($(titleSel).val());
                    this.Content($(contentSel).val());
                    this.Public($(publicSel).prop("checked"));
                    self.postChanges("/Home/UpdatePost/", this, function(){})
                    self.toggleEditable(this);
                };

                self.addPost = function (event) {

                    event.preventDefault();
                    var newPost = {
                        Title: ko.observable($("#titleInput").val()),
                        Content: ko.observable($("#contentInput").val()),
                        Public: ko.observable($("#publicInput").prop("checked"))
                    };
                    self.postChanges("/Home/AddPost/", newPost, function(data){
                        if(data != "false"){
                            var post = new Data(newPost);
                            post.Id = data;
                            self.posts.push(post);
                            self.validPost = false;
                        }
                    });
                };

                self.postChanges = function (strLocation, postData, callback) {
                    var post = ko.mapping.toJS(postData);
                    $.ajax({
                        url: strLocation,
                        type: "POST",
                        dataType: "text",
                        data: postData,
                        success: callback,
                        error: function(textStatus) {
                            alert("Something went wrong, post failed.");
                            //alert(textStatus.responseText);
                        }
                    });
                };

                self.logOut = function () {
                    $.post("/Login/Logout");
                }
            };
            ko.applyBindings(postVM());
        </script>
    </body>
</html>